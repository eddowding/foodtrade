{% extends 'tbase.html' %}
{% load staticfiles %}
{% block head %}
<link rel="stylesheet" href="/static/css/docsupport/prism.css">
<link rel="stylesheet" href="/static/css/chosen.min.css">
<style type="text/css"> 
	  .chosen-rtl .chosen-drop { left: -9000px; }
  .typeempty{
  display:none;
  }   
    .panel-body input[type=checkbox]:checked + label { 
        color: #c00; 
    } 
    .my-margin{
    	margin-top:5%;
    }
    .newmargin{
    	margin-right: 1.5%;
    }
    .modal-address-margin{
    	margin-left: 5%;
    	margin-top: 5%;
    	width: 90%;
    }
    .margin-sua{
    	margin-left: 5%;
    	width: 90%;
    }
    .li-height{
    }
    .margin-button{
    	margin-top: 18%;
    }
</style>
{% endblock %}
{% block content %}
<div class="col-md-10" >
	<div class="panel panel-default">
	<div class="panel-heading clearfix">

	<div class="col-md-6">
	  <div class="input-group">
	    <!-- USE TWITTER TYPEAHEAD JSON WITH API TO SEARCH -->
	    <input class="form-control" id="inputFindFriends" name="q" placeholder="Search for" required>
	    <span class="input-group-btn">
	        <button  type="submit" id="btnFindFriends" class="btn btn-default"><i class="glyphicon glyphicon-search"></i></button>
	    </span>
	  </div>
	</div>

 	<button id="btnBulkUpdate1" onclick="update_clicked()" class="btn btn-primary pull-right">Bulk Update</button>

	<ul class="list-group"> 
	<ul class=" list-group-item my-margin">
		<form id="contact"  class="form" role="form">
		    <div class="form-group">
		      <label for="id_sign_up_as" class="col-sm-2 control-label">Sign up as</label>
		      <div class="col-sm-5">
		        <div class="btn-group" data-toggle="buttons">
		          <label class="btn btn-default"> 
		              <input type="radio" name="sign_up_as" id="option1" value="Individual" onchange="dataradio('Individual')"> Individual 
		          </label> 
		          <label class="btn btn-default active">  
		              <input type="radio" name="sign_up_as" checked="checked" id="option2" value="Business" onchange="dataradio('Business')"> Business 
		          </label>
		          <label class="btn btn-default">
		              <input type="radio" name="sign_up_as" id="option3" value="Organisation" onchange="dataradio('Organisation')"> Organisation
		          </label>
		        </div>
		        <input type="hidden" id= "hidden_type" name="type">
		      </div>
		      </div>

	      <div class="form-group" id="type_user_id"> 
        <label for="id_type_user" class="col-sm-2 control-label">Business type</label>
        <div class="col-sm-5">
          <select id= "dropdown3" data-placeholder="Farm, wholesaler, restaurant..." multiple  class="chosen-select" tabindex="6">
              <option value=""></option>
              {% for each in all_tags %}
              <optgroup label={{each.node}}>
                {% if each.childrens %}
                  {% for eachchild in each.childrens %}
                  <option>{{eachchild.node}}</option>
                  {% endfor %}
                {% else %}
                <option>{{each.node}}</option>
                {% endif %}
              </optgroup>
              {% endfor %}
            </select>
        </div>
      </div>	

			  	<div class="form-group">
				      <label for="address" class="col-sm-2 control-label">Address</label>
				      <div>
				      <input type="text" id="address" required class="form-control" placeholder="Enter your address" value="London, UK" name="address" value="London, UK">
				      <input id="find" type="hidden" value="find" />
				      <p>Please drag and drop the marker to change your location.</p>
				      <div class="map_canvas" style="width: 100%; height: 250px; margin-top:3%;"></div>
				      <input name="lat" id="lat" type="hidden" value=""  class="form-control">
				      <input name="lng" id="lng" type="hidden" value=""  class="form-control">
				      <input name="formatted_address" type="hidden" value="" id="formatted_address" class="form-control">
			    	</div>
			    </div>
	    </form>
	</ul>
	  <ul class="list-group-item my-margin" id ="myFriendsLi">
	   {% for each in unclaimed_profiles %}
	    <li id = "li{{each.username}}" class="list-group-item li-height">
	      <!-- only show this if checkbox selected --> 
	      <div class="checkbox">
	        <input type="checkbox" id="checkbox{{forloop.counter}}" onclick="bulk_update('{{each.username}}', '{{forloop.counter}}')" />
	        {%if each.recently_updated %}
	        <i class="glyphicon glyphicon-ok" title="Recently Updated"></i> 
	        {% endif %}
      		<a href="/profile/{{each.username}}/"><img src="{{each.profile_img}}" title="{{each.name}}" class="img-responsive pull-left" style="width:20px; margin-right: 5px;" /></a>
      		{{each.name}}&nbsp;<span class="text-muted small">@{{each.screen_name}}</span>
      		<span class="pull-right"><i class="glyphicon glyphicon-edit"></i><a href="/editprofile/{{each.username}}/">Edit</a></span>
	        	
	      </div>
	    </li>   
	    {% endfor %}
	  </ul>

	  <li class="list-group-item clearfix" style="background: #eee;">
		<ul class="pagination">
			<li class="pull-left"><a id="page_dec" title="previous" onclick="get_new_page('0')">&laquo;</a></li>
			<li class="pull-right"><a id="page_inc" title="next" onclick="get_new_page('1')">&raquo;</a></li>
		</ul>
		<ul class="pull-right margin-button"><button id="btnBulkUpdate1" onclick="update_clicked()" class="btn btn-primary pull-right">Bulk Update</button></ul>
      </li>

	  </ul> 
</div>
</div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
<script src="/static/js/chosen.jquery.min.js" type="text/javascript"></script>
<script src="/static/css/docsupport/prism.js" type="text/javascript" charset="utf-8"></script>
  

<script type="text/javascript">

function dataradio(value){
    // var result_val = $("input[name=options]:checked").val();
    business_type = value;
    if (value == "Business"){
        if ( $('#type_user_id').hasClass('typeempty') ){
          $('#type_user_id').removeClass('typeempty');
          /*$('#dropdown3').attr('required','true');*/
        }
    }
    else{
        if ( $('#type_user_id').hasClass('typeempty') ){
          }
        else{
            $('#type_user_id').addClass('typeempty');
        }
        /*$('#dropdown3').removeAttr('required');*/
    }
}
var config = {
      '.chosen-select'           : {max_selected_options: 3},
      '.chosen-select-deselect'  : {allow_single_deselect:true},
      '.chosen-select-no-single' : {disable_search_threshold:10},
      '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
      '.chosen-select-width'     : {width:"350px"}
    }
    for (var selector in config) {
      $(selector).chosen(config[selector]);
    }
    $('#dropdown3').chosen().ready(function(){
      $('.search-field input').attr('style', 'width:192px;height:30px;');
    });

function copydata(){
    var all_values = '';
    var elements = document.getElementsByClassName('search-choice');
    for(i=0;i<elements.length;i++){
      if(all_values==''){
        all_values = all_values + elements[i].children[0].innerHTML;  
      }
      else{
      all_values = all_values + ',' + elements[i].children[0].innerHTML;
      }
    }
    document.getElementById('hidden_type').value = all_values;
}

 $(function(){
      $("#address").geocomplete({
        map: ".map_canvas",
        details: "form ",
        markerOptions: {
          draggable: true
        }
      });
      
      $("#address").bind("geocode:dragged", function(event, latLng){
          lat = latLng.lat();
          lng = latLng.lng();

          $("input[name=lat]").val(lat);
          $("input[name=lng]").val(lng);
          $("#reset").show();

          var mylatlng = new google.maps.LatLng(lat,lng);
          geo_code(mylatlng);
      });
      
      
      $("#find").click(function(){
        $("#address").trigger("geocode");
      }).click();

    });

 function geo_code(latlng){
    geocoder = new google.maps.Geocoder();
    geocoder.geocode({'latLng': latlng}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              if (results[1]) {
                var formatted_address = results[1].formatted_address;
                $('#address').val('');
                $('#address').val(formatted_address);
                $('#formatted_address').val(formatted_address);
              } 
            } 
          });
}
var update_of = [];
function bulk_update(username, count){
	var chkbx_status = document.getElementById('checkbox' + String(count)).checked;
	if(chkbx_status == false){
		update_of.pop(username);
	}
	else{
		update_of.push(username);
	}
}

function update_clicked(){
	if (update_of.length >0 )
	{
	  copydata();
	  formatted_address = $('#address').val();
	  lat = $("#lat").val();
	  lng = $("#lng").val();
	  type = $("#hidden_type").val();
	  sign_up_as = $('input[name=sign_up_as]').val();
	  ajax_request('unclaimed_profiles_bulk_update', 'unclaimed_profiles_bulk_update_success',{
	  	'lat':lat,
	  	'lng':lng,
	  	'formatted_address':formatted_address,
	  	'users':String(update_of),
	  	'type':type,
	  	'sign_up_as':sign_up_as
	  })
	}
	else{
		alert("Please select someone.");
	}
	
}

var current_page = 1;
function unclaimed_profiles_bulk_update_success(data){
	data = jQuery.parseJSON(data);
	if(data['status']=='1'){
		get_new_page(current_page);
	}
}

function get_new_page(page){
	if(page==1){
		current_page = current_page +1;
	}
	else{
		if(current_page <= 0){
			current_page = 1;
		}
		else{
		current_page = current_page -1;	
		}
	}
	ajax_request('get_unclaimed_paginated', 'success_unclaimed_paginated',{'current_page':current_page});
}

function success_unclaimed_paginated(data){
	data = jQuery.parseJSON(data);
	unclaimed_profiles = data['unclaimed_profiles'];
	$('#myFriendsLi').html('');
	var str = '';
		for (each in unclaimed_profiles){
	    	str = str +  '<li id = "li"' + String(unclaimed_profiles[each]['username']) +'" class="list-group-item li-height">';
	        str = str + '<div class="checkbox">';

	        if (String(unclaimed_profiles[each]['recently_updated'])=='true'){
	        	str = str + '<i class="glyphicon glyphicon-ok" title="Recently Updated"></i>';
	        }
	        
	        str = str + '<input type="checkbox" id="checkbox"'+ String(each)  + 'onclick="bulk_update(\''; 
	        str = str + String(unclaimed_profiles[each]['username']) + '\',\'' + String(each) + '\')" />';
      		str = str + '<a href="/profile/' + String(unclaimed_profiles[each]['username']) + '/">';
      		str = str + '<img src="' + String(unclaimed_profiles[each]['profile_img']);
      		str = str + '" title="' + String(unclaimed_profiles[each]['name']) + '" class="img-responsive pull-left" style="width:20px; margin-right: 5px;" /></a>';
      		str = str + String(unclaimed_profiles[each]['name']) + '&nbsp;<span class="text-muted small">@';
      		str = str + String(unclaimed_profiles[each]['screen_name']) + '</span>';
      		str = str + '<span class="pull-right"><i class="glyphicon glyphicon-edit"></i><a href="/editprofile/';
      		str = str + String(unclaimed_profiles[each]['username']) + '/">Edit</a></span>';
	        str = str + '</div>';
	    	str = str + '</li>';
		}
	$('#myFriendsLi').html(str);
}

</script>
{% endblock %}