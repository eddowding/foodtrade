{% extends 'tbase.html' %}
{% load staticfiles %}
{% load activity_tags %}
{% block head %}

{% endblock %}
{% block content %}
 <script src="https://rawgithub.com/kartena/Proj4Leaflet/master/lib/proj4-compressed.js"></script><!-- proj4js -->
  <script src="https://rawgithub.com/kartena/Proj4Leaflet/master/src/proj4leaflet.js"></script><!-- proj4leaflet -->
  <script src="https://rawgithub.com/rob-murray/os-leaflet/master/src/osopenspace.js"></script><!-- OS OpenSpace layer -->
<div class="container-responsive block-center">


    <div class="col-xs-12 col-sm-7 {% if not user.is_authenticated %} col-md-offset-1 col-sm-offset-1 {% endif %}" id="activity_switcher">

<div id="structured_postupdate" class="clearfix well well-sm" style="margin-top: 10px; padding: 10px;">

<form action="r" method="post" id="structured_input_form" accept-charset="utf-8" onsubmit="generate_update()" class="form" role="form">   
  
  <div class="row" style="margin-bottom:0;"> 
    <div class="col-xs-12">    
      <div  id="post_for">
          <button type="button" class="btn btn-stroke btn-primary btn-icon-stacked" onclick="show_full_structure();$('#price').show();" value="buy"><i class="fa fa-2x fa-sign-in"></i> 
              <span>I'd like  
                  <br>to buy </span>
          </button> 
          <button type="button" class="btn btn-stroke btn-primary btn-icon-stacked" onclick="show_full_structure();$('#price').show();" value="sell"><i class="fa fa-2x fa-sign-out"></i> 
              <span>I'd like  
                  <br>to sell </span>
          </button> 
          <button type="button" class="btn btn-stroke btn-primary btn-icon-stacked" onclick="show_full_structure();$('#price').hide();" value="offer surplus"><i class="fa fa-2x fa-refresh"></i> 
              <span>I'd like  
                  <br>to offer surplus </span>
          </button> 
          <button type="button" class="btn btn-stroke btn-primary btn-icon-stacked" onclick="swith_update_form()" value="freestyle"><i class="fa fa-2x fa-rocket"></i> 
              <span>Go 
                  <br>freestyle </span>
          </button> 
        </div>             
    </div>
  </div>
 

<span class="hidden" id="structured_hidden_block">
  <div class="row" style="margin-top: 10px;"> 
    <div class="col-xs-6"> 
      <input type="text" name="produce" value="" class="form-control" placeholder="What?"  />  
      <p class="help-block">eg 'apples', 'veg curry'</p>
    </div>
    <div class="col-xs-6"> 
      
<div class="row">
    <div class="col-xs-7" style="padding-right:0;">
      <input type="text" name="qty" value="" class="form-control" placeholder="How much?"  />  
    <p class="help-block">Weight / vol / size</p>
    </div>

    <div class="col-xs-5" style="padding-left: 0;">

      <select id="qtyUnit" class="form-control btn-sm selectpicker">        
        <option value="">Select unit</option>   
        <option value="Pieces">Pieces</option>
        <option value="20' Container">20' Container</option>
        <option value="40' Container">40' Container</option>
        <option value="Acre/Acres">Acre(s)</option>
        <option value="Bags">Bags</option>
        <option value="Barrel/Barrels">Barrel(s)</option>
        <option value="Boxes">Boxes</option>
        <option value="Bushel/Bushels">Bushel(s)</option>
        <option value="Case/Cases">Case(s)</option>
        <option value="Centimeter/Centimeters">Centimeter(s)</option>
        <option value="Cubic Meter/Cubic Meters">Cubic Meter(s)</option>
        <option value="cubic yards">Cubic Yard(s)</option>
        <option value="doz">Dozen</option>   
        <option value="gall">Gallon(s)</option> 
        <option value="ha">Hectare(s)</option> 
        <option selected="selected" value="Kg">Kilogram(s)</option>
        <option value="l">Litre(s)</option> 
        <option value="m">Meter(s)</option>    
        <option value="pallet(s)">Pallet(s)</option> 
        <option value="pint(s)">Pint(s)</option>
        <option value="pound(s)">Pound(s)</option>  
        <option value="roll(s)">Roll(s)</option>
        <option value="sets">Sets</option>
        <option value="sheet(s)">Sheet(s)</option>  
        <option value="stone">Stone(s)</option> 
        <option value="ton(s)">Ton(s)</option> 
        <option value="tray(s)">Tray(s)</option>
        <option value="unit(s)">Unit(s)</option>
        <option value="yard(s)">Yard(s)</option>
      </select>
    </div>
    </div> 
    </div>
  </div>
  <div class="row">
    <div class="col-xs-6" id="price"> 
      <input type="text" name="Price" value="" class="form-control" placeholder="Price"  />  

      <p class="help-block">Total, or per unit. Inc Â£/$/&euro;</p>
    </div>
    <div class="col-xs-6"> 
      <div class="input-group">
        <input type="text" class="form-control" id="expire_on" placeholder="When?"><span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
      </div>
      <p class="help-block" id="date_help">try 'next Friday', '8 sept 17'</p>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-12"> 
      <textarea class="form-control" id="update_description" rows="3" placeholder="Add detail: eg quality, variety, grade, packaging, etc.  "></textarea>
      <p class="help-block">
      Add detail: eg quality, variety, grade, packaging, etc.
</p>
    </div> 
  </div>
  <div class="row" style="margin-top: 5px;">
            <div class="col-xs-7">
              <ul class="list-inline small" style="margin-bottom:0;">
                <li class="text-muted">Also send to </li>
                <li> 
                  <label>
                    <input type="checkbox" id="structured_post_to_twitter" name="post_to_twitter" value="1" checked="checked">
                    <i class="fa fa-twitter-square fa-lg text-muted"></i>
                  </label>
                </li>
                <li> 
                  <label rel="tooltip" title="Post to Facebook, coming soon!">
                    <input type="checkbox" name="post_to_facebook" value="1" disabled > 
                    <i class="fa fa-facebook-square fa-lg text-muted"></i>
                  </label>
                </li>
                <li> 
                  <label rel="tooltip" title="Follower newsletters, coming soon!">
                    <input type="checkbox" name="post_to_newsletter" value="1" disabled> 
                    <i class="fa fa-list-alt fa-lg text-muted"></i> 
                  </label>
                </li> 
              </ul> 
            </div>
            <div class="col-xs-5 text-right">
            {% if not user.is_authenticated %}
                <a href="/payments" class="btn btn-success pull-right"  rel="tooltip" title="Join free to post an upate">LOGIN TO POST
                <br />
                <span class="  small">Sign up is free</span></a>
            {% else %}
              {% if can_tweet %} 
                <button type="button" id="btn_update_activity" class="btn  btn-success pull-right" rel="tooltip"  {% if not user.is_authenticated %}  title="Please login to use this feature." {% endif %} onclick="generate_update();"> Post this</button>
              {% else %} 
                <a href="/payments" class="btn  btn-success pull-right"  rel="tooltip" title="You're limited to 1 update every 7 days. Please upgrade your account to unlock."  {% if not user.is_authenticated %}  title="Please login to use this feature." {% endif %} > Upgrade to post</a>
              {% endif %}
            {% endif %}
            </div>
          </div> 
</span>
</form>

<script type="text/javascript">
function swith_update_form()
{
  switch_text_area();
  $("#structured_postupdate").hide();
  $("#update-big").show();
}

function show_full_structure()
{
  $("#structured_hidden_block").removeClass("hidden");
}

function show_small_structure()
{ 
  switch_text_area
  $("#update-big").hide();
  $("#structured_postupdate").show();
  $("#structured_hidden_block").removeClass("hidden");
}
</script>
</div>
<div id="update-small" class="well well-sm clearfix hidden" style="margin-top: 10px;">
        <input class="form-control col-xs-12"  {% if not user.is_authenticated %}  onfocus="login_redirect()" title="Please login to use this feature." {% else %} {% if can_tweet %} onfocus= "switch_text_area()"{% else %} rel="tooltip" title="You're limited to 1 update every 7 days. Please upgrade your account to unlock." {% endif %}{% endif %} placeholder="What #food do you have to #buy, #sell, or #surplus?">  
      </div> 

      <div id="update-big" class="well well-sm clearfix hidden" style="margin-top:10px;">
        <form class="form-horizontal">
          <div class="row" style="margin-bottom:0;"> 
            <div class="col-xs-12">  
             <p style="line-height: 2.5; margin: 0 10px 0 0;" class="pull-left"><strong>I'd like to...</strong> 
              <div class="btn-group btn-bl ock pull-left" id="post_for">
              <!-- <input type="hidden" /> -->
                <button type="button" onclick="show_small_structure();$('#price').show();"  class="btn btn-default" value="buy" ><i class="fa fa-sign-in fa-fw"></i> buy</button>
                <button type="button" onclick="show_small_structure();$('#price').show();" class="btn btn-default" value="sell" ><i class="fa fa-sign-out fa-fw"></i> sell</button>
                <button type="button" onclick="show_small_structure();$('#price').hide();"   class="btn btn-default" value="offer surplus"  ><i class="fa fa-random fa-fw"></i> offer surplus</button>
                <button type="button" onclick="swith_update_form()"   class="btn btn-default" value="offer surplus"  ><i class="fa fa-rocket fa-fw"></i> go freestyle</button>
              </div>                     
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="col-xs-12">
              <textarea class="form-control col-xs-12 counted" onkeyup="check_limit()" rows="3" name="q" id="newstatus" {% if not user.is_authenticated %}  onfocus="login_redirect()" title="Please login to use this feature." {% endif %} placeholder="What would you like? Eg '300kg #surplus conference #pears for #sale or #surplus' or 'I want to  #buy organic #honey for my farm shop.' "></textarea>
            </div>
          </div>

          <div class="row" style="margin-top: 5px;">
            <div class="col-xs-7">
              <ul class="list-inline small" style="margin-bottom:0;">
                <li class="text-muted">Also send to </li>
                <li> 
                  <label>
                    <input type="checkbox" id="post_to_twitter" name="post_to_twitter" value="1" checked="checked">
                    <i class="fa fa-twitter-square fa-lg text-muted"></i>
                  </label>
                </li>
                <li> 
                  <label rel="tooltip" title="Post to Facebook, coming soon!">
                    <input type="checkbox" name="post_to_facebook" value="1" disabled > 
                    <i class="fa fa-facebook-square fa-lg text-muted"></i>
                  </label>
                </li>
                <li> 
                  <label rel="tooltip" title="Follower newsletters, coming soon!">
                    <input type="checkbox" name="post_to_newsletter" value="1" disabled> 
                    <i class="fa fa-list-alt fa-lg text-muted"></i> 
                  </label>
                </li> 
              </ul> 
            </div>
            <div class="col-xs-5 text-right">
              <span class="small text-muted counted" id="charsRem">
                120 characters remaining
              </span>
            </div>
          </div>


              <button type="button" id="btn_update_activity" class="btn btn-sm btn-success pull-right" {% if not user.is_authenticated %}  title="Please login to use this feature." {% endif %} onclick="post_new_status();"> Post</button>
          </form>

          
         
  
  </div> 
<div class="row" style="margin: 10px 0;">
<div class="ftstrip ftstrip-mini"></div>
</div>

<div class="widget widget-tabs widget-tabs-double widget-tabs-responsive">

<div class="widget-head">
    <ul>
        <li class="active"><a href="#tab1-2" class="glyphicons shop" data-toggle="tab"><i></i><span class="strong">Companies</span> <span class="small text-muted">370 within 30 miles</span></a>
        </li>
        <li><a href="#tab2-2" class="glyphicons group" data-toggle="tab"><i></i><span class="strong">Organisations</span><span class="small text-muted" id="update_count">{{results_updates_count}} within 30 miles</span></a>
        </li>
        <li><a href="#tab3-2" class="glyphicons user" data-toggle="tab"><i></i><span class="strong">Individuals</span></a>
        </li>
        <li><a href="#tab4-2" class="glyphicons refresh" data-toggle="tab"><i></i><span class="strong">Trades</span>
          <div class="ribbon-wrapper small">
              <div class="ribbon danger">Upgrade</div>
          </div></a>
        </li>
    </ul>
</div>

Put things here

</div><!-- widget --> 



<div class="box-generic">
    <div class="timeline-top-info">
        <i class="fa fa-user"></i>  <a href="" class="text-inverse">mosaicpro</a> wrote
        a <a href="" class="text-info">comment</a> to
        <a href="#">
            <img src="../assets/images/people/80/2.jpg" width="20">
            </a> <a href="">Jane S.</a>
            <div class="timeline-bottom">
                <i class="fa fa-clock-o"></i> 6
                days ago
            </div>
    </div>
    <div class="bg-gray innerAll border-top">Good Job. Congrats and hope to see you
        soon.</div>
</div>

<div class="widget">
    <div class="widget-body padding-none">
        <p class="margin-none innerAll"><i class="fa fa-quote-left fa-4x pull-left"></i> Aliquam
            rutrum, sem at scelerisque tempor,
            nulla diam pulvinar tortor, id pulvinar
            massa velit eu purus. Curabitur eu
            fringilla diam, sed suscipit lorem.
            Class aptent taciti sociosqu ad litora
            torquent per conubia nostra, per inceptos
            himenaeos. Cras iaculis enim vel odio
            imperdiet faucibus. Aliquam erat volutpat.</p>
        <div class=" border-top innerAll ">
            <button class="btn btn-inverse  btn-xs pull-right"><i class="fa fa-sign-in"></i>
            </button>
            <span class=" half inline-block">
                <i class="fa fa-calendar text-primary fa-fw"></i> 22
                nov 2013 &nbsp;
                <i class="fa fa-tag text-primary fa-fw"></i> 
                <span class="label label-primary">tagged</span>&nbsp;
            </span>
            <div class="clearfix"></div>
        </div>
    </div>
</div>

<div class="widget">
<div class="media">
    <a href="" class="pull-left">
        <img src="http://pbs.twimg.com/profile_images/378800000141996074/6a363e3c4f2a84a956c3cb27c50b2ca0_normal.png" width="50" class="media-object" style="width: auto; height: auto; display: block; margin-left: auto; margin-right: auto;">
    </a>
    <div class="media-body innerTB half">
        <a href="#" class="pull-right innerT innerR text-muted"><i class="icon-reply-all-fill fa fa-2x "></i></a>
        <a href="" class="strong display-block">Just Mary</a>
        <p>I'd like to sell <a href="/activity/?q=%23cheese">#cheese</a> (organic msc). 50 Kg. By 2-4-2014.</p>
 
    </div>
    <div class="innerAll border-top small">
      <span class="pull-right time_ago">
         <a href="/foodtradeHQ/post/451355345244651521" class="text-muted"><i class="fa fa-clock-o"></i> 12 days</a> 
      </span>
      <span class="hidden-sm hidden-xs pull-left truncate100">
        <i class="fa fa-map-marker"></i>
        44 Fairfield Road, Bristol, City of Bristol BS6 5JP, UK
      </span>
      <a href="http://maps.google.com/maps?saddr=51.4694953,-2.5815688&amp;daddr=51.4694953,-2.5815688" target="_blank" data-placement="top" data-toggle="tooltip" class="text-muted pull-left" rel="tooltip" title="" data-original-title="Get directions"> 
        <i class="fa fa-location-arrow"></i> 0.0 miles  
      </a>
      
    </div>
</div>
</div>

<ul class="nav nav-tabs">
  <li {% if results_updates_count != 0  or results_individual_count == 0 and results_business_count == 0 and results_organisation_count == 0  %}class="active dropdown"{% endif %}>
    <a href="#" id="more" class="dropdown-toggle" data-toggle="dropdown">Updates 
      <span class="badge" id="update_count">{{results_updates_count}}</span>
      <b class="caret"></b>
    </a>
    <ul class="dropdown-menu" role="menu" aria-labelledby="more">
      <li><a href="/activity"><i class="fa fa-fw fa-bell-o"></i> All </li> 
      <li><a href="/activity/?q=sell"><i class="fa fa-fw fa-sign-out"></i> Sell</li> 
      <li><a href="/activity/?q=buy"><i class="fa fa-fw fa-sign-in"></i> Buy</a></li> 
      <li><a href="/activity/?q=surplus"><i class="fa fa-fw fa-refresh"></i> Surplus</a></li> 
      <li><a href="/activity/?q=ask"><i class="fa fa-fw fa-comment-o"></i> Ask</a></li> 
      <li><a href="/activity/?q=job"><i class="fa fa-fw fa-eur"></i> Job</a></li> 
    </ul>
  </li> 
 


  <li {% if results_updates_count == 0 and results_individual_count == 0  and results_organisation_count == 0 and results_business_count != 0 %}class="active"{% endif %}>
    <a href="#biz" data-toggle="tab">Business 
    <span class="badge" id="business_count">{{results_business_count}}</span>
    </a>
  </li> 

    <li {% if results_updates_count == 0 and results_individual_count == 0 and results_business_count == 0 and results_organisation_count != 0 %}class="active"{% endif %}>
    <a href="#org" data-toggle="tab">Orgs
    <span class="badge" id="organisation_count">{{results_organisation_count}}</span>
    </a>
  </li> 
    <li {% if results_updates_count == 0  and results_business_count == 0 and results_organisation_count == 0 and results_individual_count != 0 %}class="active"{% endif %}>
    <a href="#indiv" data-toggle="tab">People 
    <span class="badge" id="individual_count">{{results_individual_count}}</span>
    </a>
  </li>
</ul>

<div class="tab-content reply_text" id = "filtered_content">
  <div class="tab-pane {% if results_updates_count != 0  or results_business_count == 0 and results_organisation_count == 0  %}active{% endif %}" id="near_me">
 
   <div id="sortby" class="clearfix">

      <div class="pull-left">
        <p class="text-muted" style="margin:0;">Filter:
          <a href="/activity/?q=buy" class="text-muted">#buy</a>
          <span class="text-muted">/</span>
          <a href="/activity/?q=sell" class="text-muted">#sell</a>
          <span class="text-muted">/</span>
          <a href="/activity/?q=surplus" class="text-muted">#surplus</a>
        </p>
      </div>

      <div class="btn-group pull-right">
      <input type="hidden" id="current_sort_order" value="time" />
        <span class="pull-left small text-muted" style="position: relative; top: 3px; margin-right: 2px;">Sort by </span>
        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
          <span  id="current_sort_text" class="text-muted"><i class="fa fa-clock-o fa-fw"></i> Time posted</span>
          <span class="caret text-muted"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a onclick="sort_by('distance',this)"><i class="fa fa-location-arrow fa-fw"></i> Distance from {% if search %} {{ search.place }} {% endif %} {% if not search %} {{userinfo.zip_code}}{% endif %}</a></li>
          <li><a onclick="sort_by('time',this)"><i class="fa fa-clock-o fa-fw"></i> Time posted</a></li>
        </ul>
      </div> 

   </div>





<div class="activity" id="activity_updates"> 
 {% include 'activity_updates.html' %}
  </div>

</div><!-- tab pane activity -->



  <div class="tab-pane {% if results_updates_count == 0 and results_business_count == 0  and results_organisation_count == 0 and results_individual_count != 0 %}active{% endif %}" id="indiv">
 
  <div class="activity" id="activity_indiv"> 
{% include 'activity_indiv.html' %}
  </div>


  </div> 




  <div class="tab-pane {% if results_updates_count == 0 and results_individual_count == 0  and results_organisation_count == 0 and results_business_count != 0 %}active{% endif %}" id="biz">
 
  <div class="activity" id="activity_biz"> 
  {% include 'activity_biz.html' %}
   
  </div>


  </div> 



  <div class="tab-pane {% if results_updates_count == 0 and results_individual_count == 0 and results_business_count == 0 and results_organisation_count != 0 %}active{% endif %}" id="org">
 
  <div class="activity" id="activity_org"> 
   {% include 'activity_org.html' %}
  </div>


  </div> 
  <!-- close organisation tab -->



</div><!-- tabs -->


     
    </div><!-- closes 5 -->

    <div class="col-sm-5 col-xs-12 fill"  style="  right:0px;">

    <!-- FIX THE MAP POSITION SO IT DOES NOT SCROLL --> 
      <div id="map" style=" position: fixed; width:50%;
height: 100%; " >
        

        <div class="alert alert-warning"> 

          <p>There are radius lines at 15, 30, and 100 miles.</p>
        </div>

      </div>
    </div>
    </div>
    <script type="text/javascript">
    map_lat={{ search.lat }};
    map_lon = {{ search.lon }};



      food_filters = {{foods_filter |safe}};
      business_filters = {{business_filter |safe}};
      organisation_filters = {{organisation_filter |safe}};



    </script>
      

  {% endblock %}


          {% block footer %}
    {% include "includes/not_logged_in_modal.html" %}
           <script src="{% static "js/activity.js" %}"></script>
           <script src="{% static "js/date.js" %}"></script>

           <script type="text/javascript">
           $("#expire_on").keyup(function(){
             var expire_on = Date.parse($("#expire_on").val());
             if(expire_on!=null)
             {
              var expire_date = expire_on.getDate()+"/"+expire_on.getMonth()+"/"+expire_on.getFullYear();
  $("#date_help").html(expire_date);

             }
 
    
});
show_food_filters(food_filters, 0);
show_organisation_filters(organisation_filters, 0);
show_business_filters(business_filters, 0);

var post_for = "";
$('#post_for').children(".btn").click(function(){
    var value = $(this).val();
    var childrens = $('#post_for').children();
    for(var i=0;i<childrens.length;i++)
    {
      $(childrens[i]).removeClass("btn-success");
    }
    $(this).addClass("btn-success");
    post_for = value;
});

function generate_update()
{
  if(post_for=="")
  {
    alert("Select one of buy / sell / surplus");
    return;
  }
  var input_produces = $("input[name=produce]").val();
  if(input_produces.trim()=="")
  {
    alert("You can't leave produce empty");
    return;
  }
  var produces_name = input_produces.trim().replace("'", "").replace('"','').split(",");
  var quantity = $("input[name=qty]").val().trim();
  var quantity_unit = $("#qtyUnit").val();
  var quantity_text = "";
  if(quantity!="" && quantity_unit!="")
  {
    quantity_text =  " "+quantity+" "+quantity_unit+".";
  }

  var expire_on = Date.parse($("#expire_on").val());
  var expire_text = "";
  if(expire_on!=null)
  {
    var expire_date = expire_on.getDate()+"-"+expire_on.getMonth()+"-"+expire_on.getFullYear();
    expire_text = " By "+expire_date+".";
  }
  var description = $("#update_description").val().trim();
  var description_text = "";
  if(description!="")
  {
    description_text = " ("+description+")";
  }
  

  var produces_hash = "";
  for(var i = 0;i<produces_name.length;i++)
  {
    if(produces_name[i].trim() == "")
    {
      continue;
    }
    produces_hash += "#" + produces_name[i].trim();

    if((i+1) != produces_name.length)
    {
        produces_hash += ", ";
    }
  }
  var update_text = "I'd like to "+post_for+" "+produces_hash+description_text+"."+quantity_text+expire_text;

  activity_status_update(update_text);
  return false;
}
           </script>

 {% endblock %}
 {% block javascript %}
     <script src="{% static "js/activity-map.js" %}"></script>

{% endblock %}