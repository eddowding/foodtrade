 {% extends 'tbase.html' %}
{% load staticfiles %}

{% block content %}



    <div class="col-md-5 col-sm-5" id="activity_switcher">
 
 
<ul class="nav nav-tabs hidden">
  <li class="active">
    <a href="#activity" data-toggle="tab">Activity 
      <span class="badge">{{userinfo.nearby_individuals_no}}</span>
    </a>
  </li>
  <li>
    <a href="#biz" data-toggle="tab">Businesses 
    <span class="badge">{{userinfo.nearby_businesses_no}}</span>
    </a>
  </li> 
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="near_me">
 

  <div id="update" class="well well-sm">
    
        <div class="input-group"> 
          <input class="form-control" name="q" id="newstatus" {% if not user.is_authenticated %}  onfocus="login_redirect()" title="Please login to use this feature." {% endif %} placeholder="What #food do you have to #buy, #sell, or #surplus?">
          <span class="input-group-btn">
              <button type="button" id="btn_update_activity" class="btn btn-success" {% if not user.is_authenticated %}  title="Please login to use this feature." {% endif %} onclick="UpdateActivity('newstatus');"> Post</button>
          </span>
        </div>

    <div class="help-block small hidden-sm">
    <ul>
    <li>300kg #surplus conference #pears for #sale or #surplus</li>
    <li>I want to  #buy organic #honey for my farm shop.</li>
    </ul>
    </div>
  </div> 

 <div id="sortby" class="clearfix">

    <div class="btn-group pull-right">
      <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
        Sort results
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li><a onclick="sort_by('distance')"><i class="fa fa-location-arrow fa-fw"></i> Distance from {% if search %} {{ search.place }} {% endif %} {% if not search %} {{userinfo.zip_code}}{% endif %}</a></li>
        <li><a onclick="sort_by('time')"><i class="fa fa-clock-o fa-fw"></i> Time posted</a></li>
      </ul>
    </div> 

 </div>

  <div id="activity"> 
        <ul class="chat">





{% if results %}

{% for result in results %}

    <li class="left clearfix " id="{{result.uid.id}}"><span class="chat-img pull-left">
    <img src="{{result.user.profile_img}}" alt="{{result.user.name}}" class="img-thumbnail" />
    </span>
        <div class="chat-body clearfix">
 

        <div class="btn-group pull-right" style="margin-left: 5px;">
            <button type="button" class="btn btn-default dropdown-toggle btn-xs pull-left" data-toggle="dropdown">
              <i class="fa fa-link fa-large text-muted"></i>
                <span class="caret text-muted"></span>
            </button> 
            <ul class="dropdown-menu" role="menu">
              {%  if userinfo.user_type == "Business" and result.sign_up_as == "Business" and result.user.username != userinfo.username %}
              <li><a href="#" onclick="click_activity('buyFrom','{{result.useruid}}')">I buy from</a></li>
              <li><a href="#"onclick="click_activity('sellTo','{{result.useruid}}')">I sell to</a></li> 
              <li class="divider"></li>
              {% endif %}
              {% if result.sign_up_as == "Organisation" %}
              <li><a href="#" onclick="click_activity('markMember', '{{result.useruid}}')">I'm a member</a></li>
              {% endif %}
              {% if userinfo.user_type == "Individual" and result.sign_up_as == "Business" %}
              <li><a href="#" onclick="click_activity('markCustomer', '{{result.user.username}}')">I'm a customer</a></li>
              {% endif %}
              <li class="divider"></li>
              {% ifequal result.user.username userinfo.username %}
              <li><a href="#" onclick="click_activity('delete','{{result.uid.id}}')">Delete</a></li>
              {% endifequal %}
              {% if result.user.username != userinfo.username %}
              <li><a href="#" onclick="click_activity('spam','{{result.uid.id}}')">Flag as spam</a></li>
              <li><a href="#" onclick="click_activity('follow','{{result.user.username}}')">Follow on Twitter</a></li>
              {% endif %}
              <li><a href="/profile/{{result.user.username}}/">View full profile</a></li> 
            </ul>
          </div>  


            <div class="header">
                <strong class="pull-left" style="margin-right: 10px;"><a href="/profile/{{result.user.username}}">{{result.user.name}}</a></strong> 

          {% if type_user|length == 0 or type_user|first == '' %}
          {% else %}
          <div class="tags tags-biztype">  
            {% for tag in result.type_user  %}
                  <a href="/activity/?b={{tag}}">{{tag}}</a>
                  {% endfor %}
          </div> {% endif %}
            </div>

            <p>
                {{result.status}}
            </p>

              <div class="meta small text-muted">
               <i class="fa fa-map-marker"></i>
                {{result.user.address}}

                 <!-- if logged in or you've allows html5 browser location -->
                 <a href="http://maps.google.com/maps?saddr={{userinfo.lat}},{{userinfo.lon}}&daddr={{result.location.coordinates.1}},{{result.location.coordinates.0}}" 
                    target="_blank" data-placement="top" data-toggle="tooltip" 
                    class="text-muted" 
                    title="Get directions"> 
                 <i class="fa fa-location-arrow"></i> {{result.distance_text}}  
                 </a>
                <!--  // if logged in or you've allows html5 browser location -->

                <span class="pull-right">
                   <a href="/profile/{{result.user.username}}/" class="text-muted"><i class="fa fa-clock-o"></i> {{result.time_elapsed}}</a> 
                </span>
              </div> 

        </div>

        <div class="reply well well-sm" style="margin:0;"> 
          <input class="form-control input-sm enterhandler"  class="btn btn-success" {% if not user.is_authenticated %}  title="Please login to use this feature." {% endif %} type="text" id="replyid_{{forloop.counter}}" placeholder="Reply to @{{result.user.username}}" onfocus="ShowReply('replyid_{{forloop.counter}}', '@{{result.user.username}}')" onblur="BlurReply('replyid_{{forloop.counter}}', '@{{result.user.username}}')">
        </div>
    </li>
  {% endfor %}
    {% endif %}
</ul> 
  </div>



</div><!-- tab pane activity -->
  <div class="tab-pane" id="biz">
    biz
  </div> 
</div><!-- tabs -->


     
    </div><!-- closes 5 -->

    <div class="col-md-5  col-sm-5 fill"  style="height: 1000px; ">

    <!-- FIX THE MAP POSITION SO IT DOES NOT SCROLL --> 
      <div id="map" >
        

        <div class="alert alert-warning"> 

          <p>There are radius lines at 15, 30, and 100 miles.</p>
        </div>

      </div>
    </div>
    <script type="text/javascript">
    map_lat={{ search.lat }};
    map_lon = {{ search.lon }};


{% if results %}
connections = {{json_data | safe}};
    {% endif %}
    </script>
     <script src="{% static "js/activity-map.js" %}"></script>

<span id="status_template" style="visibility: hidden;">
  <li class="left clearfix"><span class="chat-img pull-left">
    <img src="{{userinfo.profileimg}}" alt="{{result.user.name}}" class="img-thumbnail" />
    </span>
        <div class="chat-body clearfix">
 

        <div class="btn-group pull-right" style="margin-left: 5px;">
            <button type="button" class="btn btn-default dropdown-toggle btn-xs pull-left" data-toggle="dropdown">
              <i class="fa fa-link fa-large text-muted"></i>
                <span class="caret text-muted"></span>
            </button> 
            <ul class="dropdown-menu" role="menu">
              
                <li><a href="#" onclick="click_activity('delete', '{{result.uid.id}}')">Delete</a></li>
              <li><a href="/profile/{{result.user.username}}" >View full profile</a></li> 
            </ul>
          </div>  


            <div class="header">
                <strong class="pull-left" style="margin-right: 10px;">{{userinfo.full_name}}</strong> 

               
            </div>

            <p>
                ===status===
            </p>

              <div class="meta small text-muted">
               <i class="fa fa-map-marker"></i>
               {{userinfo.address}}

                 <!-- if logged in or you've allows html5 browser location -->

                 <a href="http://maps.google.com/maps?saddr=current+location&daddr={{userinfo.address}}" 
                    target="_blank" data-placement="top" data-toggle="tooltip" 
                    class="text-muted" 
                    title="Get directions"> 
                 <i class="fa fa-location-arrow"></i> 0m  
                 </a>
                <!--  // if logged in or you've allows html5 browser location -->

                <span class="pull-right">
                   <a href="activity_single.php" class="text-muted"><i class="fa fa-clock-o"></i> 0s</a> 
                </span>
              </div> 

        </div>

        <div class="reply well well-sm" style="margin:0;"> 
          <input class="form-control input-sm enterhandler"  {% if not user.is_authenticated %}  title="Please login to use this feature." {% endif %} type="text" id="replyid_{{forloop.counter}}" placeholder="Reply to @{{result.user.username}}"  onfocus="ShowReply('replyid_{{forloop.counter}}', '@{{result.user.username}}')" onblur="BlurReply('replyid_rfrf', '@{{info.username}}')">
        </div>
    </li>

</span>





  {% endblock %}


          {% block footer %}
<script type="text/javascript">
          
          function login_redirect(){
            window.location = '/accounts/twitter/login/?process=login';
          }

          food_filters = {{foods_filter |safe}};
          

          function food_value_changed(more_no)
          {
                   var results = [];
       var query = $("#food_filter").val().toLowerCase();
        for(var i = 0; i < food_filters.length;i++)
        {
          var element  = food_filters[i].uid.toLowerCase();
          if(element.indexOf(query)>-1)
          {
            results.push(food_filters[i]);
          }
        }

            show_food_filters(results,more_no);
          }

          function show_food_filters(filters, more_no)
          {
            if(more_no == 0){
            $('#food_filter_results').html('');
            }
            else
            {
              $("#food_more_"+(more_no-5)).remove();
            }
            for(var i = more_no;i<filters.length && i<(more_no+5); i++)
            {
              var checked = '';
              if(filters[i].prev)
              {
                checked = "checked='checked'";
              }

            var row = '<li data-id="15" class="foodtrade-tag foodtrade-tag-click "><div class="foodtrade-tag-checkbox-column"><input type="checkbox" '+checked+' onClick="foods_changed(this,\''+filters[i].uid+'\')" aria-label="University of Washington" class="foodtrade-tag-checkbox"></div><div class="foodtrade-tag-text"> '+filters[i].uid+'</div><div class="foodtrade-tag-count">'+filters[i].value+'</div></li>';
            $('#food_filter_results').append(row);
           
          }
           if(filters.length>more_no+5)
            {
              $('#food_filter_results').append('<li class="foodtrade-tag-showmore" id="food_more_'+more_no+'" onClick="food_value_changed('+(more_no+5)+')">show more</li>');
            }
          }





            function foods_changed(ref,food)
          {
for(var i = 0; i < food_filters.length;i++){
          if(food_filters[i].uid==food)
          {
            var status = ref.checked;
            //console.log(status);
            food_filters[i].prev = status;
          }
          }
          make_search();
        }








business_filters = {{business_filter |safe}};
          

          function business_value_changed(more_no)
          {
                   var results = [];
       var query = $("#business_filter").val().toLowerCase();
        for(var i = 0; i < business_filters.length;i++)
        {
          var element  = business_filters[i].uid.toLowerCase();
          if(element.indexOf(query)>-1)
          {
            results.push(business_filters[i]);
          }
        }

            show_business_filters(results,more_no);
          }

          function show_business_filters(filters, more_no)
          {
            if(more_no == 0){
            $('#business_filter_results').html('');
            }
            else
            {
              $("#business_more_"+(more_no-5)).remove();
            }
            for(var i = more_no;i<filters.length && i<(more_no+5); i++)
            {
              var checked = '';
              if(filters[i].prev)
              {
                checked = "checked='checked'";
              }

            var row = '<li data-id="15" class="foodtrade-tag foodtrade-tag-click "><div class="foodtrade-tag-checkbox-column"><input type="checkbox" '+checked+' onClick="business_changed(this,\''+filters[i].uid+'\')" aria-label="University of Washington" class="foodtrade-tag-checkbox"></div><div class="foodtrade-tag-text"> '+filters[i].uid+'</div><div class="foodtrade-tag-count">'+filters[i].value+'</div></li>';
            $('#business_filter_results').append(row);
           
          }
           if(filters.length>more_no+5)
            {
              $('#business_filter_results').append('<li class="foodtrade-tag-showmore" id="business_more_'+more_no+'" onClick="business_value_changed('+(more_no+5)+')">show more</li>');
            }
          }





            function business_changed(ref,business)
          {
for(var i = 0; i < business_filters.length;i++){
          if(business_filters[i].uid==business)
          {
            var status = ref.checked;
            //console.log(status);
            business_filters[i].prev = status;
          }
          }
          make_search();
        }






organisation_filters = {{organisation_filter |safe}};
          

          function organisation_value_changed(more_no)
          {
                   var results = [];
       var query = $("#organisation_filter").val().toLowerCase();
        for(var i = 0; i < organisation_filters.length;i++)
        {
          var element  = organisation_filters[i].uid.toLowerCase();
          if(element.indexOf(query)>-1)
          {
            results.push(organisation_filters[i]);
          }
        }

            show_organisation_filters(results,more_no);
          }

          function show_organisation_filters(filters, more_no)
          {
            if(more_no == 0){
            $('#organisation_filter_results').html('');
            }
            else
            {
              $("#organisation_more_"+(more_no-5)).remove();
            }
            for(var i = more_no;i<filters.length && i<(more_no+5); i++)
            {
              var checked = '';
              if(filters[i].prev)
              {
                checked = "checked='checked'";
              }

            var row = '<li data-id="15" class="foodtrade-tag foodtrade-tag-click "><div class="foodtrade-tag-checkbox-column"><input type="checkbox" '+checked+' onClick="organisation_changed(this,\''+filters[i].uid+'\')" aria-label="University of Washington" class="foodtrade-tag-checkbox"></div><div class="foodtrade-tag-text"> '+filters[i].uid+'</div><div class="foodtrade-tag-count">'+filters[i].value+'</div></li>';
            $('#organisation_filter_results').append(row);
           
          }
           if(filters.length>more_no+5)
            {
              $('#organisation_filter_results').append('<li class="foodtrade-tag-showmore" id="organisation_more_'+more_no+'" onClick="organisation_value_changed('+(more_no+5)+')">show more</li>');
            }
          }





            function organisation_changed(ref,organisation)
          {
for(var i = 0; i < organisation_filters.length;i++){
          if(organisation_filters[i].uid==organisation)
          {
            var status = ref.checked;
            //console.log(status);
            organisation_filters[i].prev = status;
          }
          }
          make_search();
        }








       function make_search()
       {
        var foods = [];
        var flag = false;
        
          for(var i = 0; i < food_filters.length;i++){
          if(food_filters[i].prev)
          {
            flag = true;
            foods.push(food_filters[i].uid);
          }
          }

          if(flag)
        {
           $('#all_foods').prop('checked', false);
          }
          else
          {
            $('#all_foods').prop('checked', true);
          }
          flag = false;
       


          var businesses = [];
          
          
          for(var i = 0; i < business_filters.length;i++){
          if(business_filters[i].prev)
          {
            flag =true;
            businesses.push(business_filters[i].uid);
          }
        }
        if(flag)
        {
           $('#all_businesses').prop('checked', false);
          }
          else
          {
            $('#all_businesses').prop('checked', true);
          }
          flag = false;




            var organisations = [];
          
          for(var i = 0; i < organisation_filters.length;i++){
          if(organisation_filters[i].prev)
          {
            flag = true;
            organisations.push(organisation_filters[i].uid);
          }
          }
          if(flag)
        {
           $('#all_organisations').prop('checked', false);
          }
          else
          {
            $('#all_organisations').prop('checked', true);
          }
          flag = false;
       
          var keyword = $("#keyword").val();
          var s_lon = $("#lon").val();
          var s_lat = $("#lat").val();
          var sort_type = $("#sortby").val();


           ajax_request("ajax_search", 'show_ajax_results', {q:keyword, lon:s_lon, lat:s_lat, foods:JSON.stringify(foods), businesses:JSON.stringify(businesses), organisations:JSON.stringify(organisations), sort: sort_type});
       }


       function show_ajax_results(data)
       {
         $('#activity').html(data);
         connections = ajax_connections;
         reload_controls();

       }
$('#food_filter').keyup( function() {
            food_value_changed(0);
        });


$('#business_filter').keyup( function() {
            business_value_changed(0);
        });

$('#organisation_filter').keyup( function() {
            organisation_value_changed(0);
        });

show_food_filters(food_filters, 0);
show_organisation_filters(organisation_filters, 0);
show_business_filters(business_filters, 0);

function click_activity(activity, changeID){
  ajax_request('activity_handle','success_activity_handle',{'user':'{{userinfo.username}}', 'changeID':changeID, 'task':activity});
}
function success_activity_handle(data){
  data = jQuery.parseJSON(data);
  if(data['status'] == 1 && data['activity'] == 'deleteTweet'){
    $('#' + String(data['_id'])).hide();
  }
  if(data['activity'] == 'follow' ){
    alert(data['message']);
  }
  if((data['activity'] == 'buyFrom' && data['status'] == 0) || 
    (data['activity'] == 'sellTo' && data['status'] ==0) || 
    (data['activity'] == 'markMember' && data['status'] == 0) ||
    (data['activity'] == 'spam' && data['status'] == 0)){
   alert(data['message']); 
  }
}


function sort_by(sort)
{
   $("#sortby").val(sort);
   make_search();
}

</script>

 {% endblock %}