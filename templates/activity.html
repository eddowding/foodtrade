{% extends 'tbase.html' %}
{% load staticfiles %}
{% load activity_tags %}
{% block head %}

{% endblock %}
{% block content %}

<div class="container-responsive block-center">

<div class="row row-merge">

<div class="col-xs-12 col-sm-4" id="activity_switcher" >


 
<div class="widget hidden" style="width:100%;">
  <div class="padding-none"> 
    <div class="input-group"  style="width:100%;">
    {% comment %}
      <textarea class="form-control"  {% if not user.is_authenticated %}  onfocus="login_redirect()" title="Please login to use this feature." {% else %} {% if not can_tweet %} data-toggle="modal" data-target="#newtwitterpost" {% else %} rel="tooltip" title="Please upgrade your account to post." {% endif %}{% endif %} style="width:100%;">What #food do you have to #buy, #sell, or #surplus?  </textarea> 
    {% endcomment %}
      <textarea class="form-control"  {% if not user.is_authenticated %}  onfocus="login_redirect()" title="Please login to use this feature." {% else %}  data-toggle="modal" data-target="#newtwitterpost" {% endif %} style="width:100%;">What #food do you have to #buy, #sell, or #surplus?  </textarea> 
    </div>
  </div>



</div>


 
<div class="container-responsive" id="searchfilters">

<div class="widget widget-tabs widget-tabs-double widget-tabs-responsive border0 margin0" style="background: #F5F8FA; padding-top: 10px;">
  <!-- Tabs Heading -->
  <div class="widget-head clearfix"  id="result_tabs" style="background: #F2F6F8;">
    <ul> 
      <li class="active " style="">
        <a href="#mktplace" class="glyphicons bullhorn" id="mkt_tab" data-toggle="tab"><i></i>
        <div class=" visible-lg">
          <span class="strong">Market place</span>
          <span>Real-time trade</span> 
        </div>
        <div class="visible-sm visible-xs visible-md">
          <span class="strong">Market</span>
          <span>Real-time</span> 
        </div>
        </a>


      </li>
      <li class="border-right" style="">
        <a href="#profiles" class="glyphicons shop" id="profile_tab" data-toggle="tab"><i></i>
        <div class=" visible-lg">
          <span class="strong">Profiles</span>
          <span>People &amp; places</span> 
        </div>
        <div class="visible-sm visible-xs visible-md">
          <span class="strong">Profiles</span>
          <span>People &amp; places</span> 
        </div>
        </a>
      </li>
    </ul>
  </div>
</div>

  <div class="widget-body innerLR" style="margin:0; background-color: #FFF;">

    <div class="tab-content">
      <!-- Tab content --> 
      <div class="tab-pane active" id="mktplace">

    <form action="/activity" onsubmit="return get_address('market');"  role="search" data-step="1" data-intro="Search for anyhing, anywhere" class="form-horizontal">

      <div class="form-group clearfix">
  
        <div class="col-sm-12 text-center">
            <div rel="tooltip" title="Filter by keyword" class="tooltips btn-group">
                <button type="button" class=" btn btn-default btn-sm btn-mwant">#buy</button>
                <button type="button" class=" btn btn-default btn-sm btn-mwant">#sell</button>
                <button type="button" class=" btn btn-default btn-sm btn-mwant">#surplus</button>
                <button type="button" class=" btn btn-default btn-sm btn-mwant">#job</button>
            </div> 
        </div>
      </div>

  
      <div class="form-group clearfix" style="background: rgba(200,200,200,0.1);"> 
        <div class="col-sm-12 text-center">
            <div rel="tooltip" title="Filter by type" class="tooltips btn-group">
                <button type="button" class="btn btn-default btn-sm btn-mut">Companies</button>
                <button type="button" class="btn btn-default btn-sm btn-mut">Individuals</button>
            </div>
        </div>
      </div>

      <div class="innerTB half" onclick="$(this).hide();">
        <a data-toggle="collapse" data-target="#filters2" class="small"><i class="fa fa-caret-right fa-fw fa-lg"></i> Advanced filters</a>
      </div>

      <div id="filters2" class=" collapse"> 
        <div class="form-group" id="locationgroup"> 
          <div class="col-sm-12 ">
            <div class="input-group innerAll input-group-sm">
              <span class="input-group-addon"><i class="fa fa-map-marker"></i></span>
              <input type="text" name="location" id="pac_input_market" class="pac-input form-control  " placeholder="Where?">
              <div class="input-group-btn">
                <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-search"></i></button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group" id="organisationgroup"> 
          <div class="col-sm-12 innerLR">
            <select class="selectpicker show-tick" data-live-search="true" multiple data-selected-text-format="count>2" title="Filter by organisation" name="filterOrg"   data-style="btn-default" id="filter_mkt_org">
              
          </select>
          </div>
        </div>

        <div class="form-group innerLR" id="companygroup"> 
          <div class="col-sm-12">
          <select class="selectpicker show-tick"   id="filter_mkt_biz"  data-live-search="true" multiple data-selected-text-format="count>2" title="Filter by company type" name="companyType"  data-style="btn-default">
          </select>
          </div>
        </div>
      </div><!-- filters -->

    </form> 
<div id="mkt_results"></div>
        </div> 
        <div class="tab-pane" id="profiles"> 

          <form action="/activity" onsubmit="return get_address('profile');" role="search" data-step="1" data-intro="Search for anyhing, anywhere" class="form-horizontal">

            <div class="form-group clearfix"> 
              <div class="col-sm-12 text-center">
                  <div rel="tooltip" title="Do you want to buy or sell?" class="tooltips btn-group">
                      <button type="button" class="btn btn-default btn-pwant btn-sm btn-pwant">Buy</button>
                      <button type="button" class="btn btn-default btn-pwant btn-sm btn-pwant">Sell</button>
                  </div> 
              </div>
            </div> 

            <div class="form-group clearfix" style="background: rgba(200,200,200,0.1);">
              <div class="col-sm-12 text-center">
                  <div rel="tooltip" title="Filter by type" class="tooltips btn-group">
                    <button type="button" class="btn btn-default btn-sm btn-put" data-toggle="collapse" data-target="#companygroup" >Companies</button>
                    <button type="button" class="btn btn-default btn-sm btn-put">Individuals</button>
                  </div>
              </div>
            </div>
 
            <div class="innerTB half" onclick="$(this).hide();">
              <a data-toggle="collapse" data-target="#filters1" class="small filters1"><i class="fa fa-caret-right fa-fw fa-lg"></i> Advanced filters</a>
            </div>

            <div id="filters1" class="collapse"> 
              <div class="form-group" id="locationgroup"> 
                <div class="col-sm-12">
                  <div class="input-group  innerAll input-group-sm">
                   <span class="input-group-addon"><i class="fa fa-map-marker"></i></span>
                    <input type="text" name="location" id="pac_input_profile" class="pac-input form-control  " placeholder="Where?">
                    <div class="input-group-btn">
                      <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="form-group" id="organisationgroup"> 
                <div class="col-sm-12 text-">
                  <select class="selectpicker show-tick" id="filter_profile_org" data-live-search="true" multiple data-selected-text-format="count>2" title="Filter by organisation" name="filterOrg"   data-style="btn-default">
                  
                </select>
                </div>
              </div>

              <div class="form-group" id="companygroup"> 
                <div class="col-sm-12">
                <select class="selectpicker show-tick" id="filter_profile_biz"   data-live-search="true" multiple data-selected-text-format="count>2" title="Filter by company type" name="companyType"  data-style="btn-default">
                 
                </select>
                </div>
              </div>
            </div><!-- filters -->

          </form> 

          <div id="profile_results"></div>
        </div>
        <!-- // Tab content END -->


    </div>

 </div> <!-- widget -->
 


     
    </div><!-- closes main col -->
    </div>


      <div class="col-sm-8 col-xs-12 fill">
         
          <div id="map"></div>
        
      </div>
    </div>

</div>

    <script type="text/javascript">
 

      // food_filters = {{foods_filter |safe}};
      // business_filters = {{business_filter |safe}};
      // organisation_filters = {{organisation_filter |safe}}; 

      function swith_update_form()
        {
          switch_text_area();
          $("#structured_postupdate").hide();
          $("#update-big").show();
        }






    </script>
      

  {% endblock %}


  {% block footer %}
    {% include "includes/not_logged_in_modal.html" %}
     <script src="{% static "js/activity.js" %}"></script>
     

 {% endblock %}
 {% block javascript %}
 <script type="text/javascript">
      // show_food_filters(food_filters, 0);
      // show_organisation_filters(organisation_filters, 0);
      // show_business_filters(business_filters, 0);
</script>


<!-- resizes the map -->
<script type="text/javascript">
var mapmargin = 0;
$('#map').css("height", ($(window).height() - mapmargin));
$(window).on("resize", resize);
resize();
function resize(){

    if($(window).width()>=980){
        $('#map').css("height", ($(window).height() - mapmargin));    
        $('#map').css("margin-top",0);
    }else{
        $('#map').css("height", ($(window).height() - (mapmargin)));    
        $('#map').css("margin-top",0);
    }

}

</script>
   


 <script src="{% static "js/activity-map.js" %}"></script>
 <script src="{% static "js/functions.js" %}"></script>
 <script src="{% static "js/search.js" %}"></script>

              <script type="text/javascript">

              var latest_timestamp = 0;
              function update_latest_updates(data)
                {
                    var updates_result = jQuery.parseJSON(data);

                    var feeds = updates_result.result;
                    var updates  = "";
                    if(feeds.length>0)
                    {
                      latest_timestamp = updates_result.time;
                    }
                    for(var i = 0;i<feeds.length;i++)
                    {
                      var item = feeds[i];
                      updates +='<div class="update" data-toggle="popover" data-title="help" data-tweet-id="'+item.updates.tweet_id+'" data-trigger="manual" data-container="body" data-placement="left" data-original-title="" title="" data-html="true"  >';
                      updates += '<img src="'+item.profile_img+'" class="pull-left" style="width:25px; margin-right: 10px;" /><p class="margin-image-left-small">'+item.updates.status+'<br /><small class="text-muted">'+get_time_text(item.updates.time_stamp)+'</small> </p></div>';


                    }
                    $("#updates").prepend(updates).fadeIn('slow');
                }


function poll_latest_updates()
{

setTimeout(function() {   
   ajax_request("get_latest_updates", 'update_latest_updates',{time:latest_timestamp});
   poll_latest_updates();
    }, 5000); 

}



              $(document).ready(function(){
                
                poll_latest_updates();
                ajax_request("get_latest_updates", 'update_latest_updates',{time:latest_timestamp});
                 $("#updates").on("click",".update",function(e){ 
                  if($(this).attr('data-trigger')!="manual")
                    return;
                  var tweet_id = $(this).attr('data-tweet-id');
                  var that = this;

                  $.post( "/ajax-handler/get_single_tweet", { tweet_id:tweet_id }, function( data ) {
                    var content = "<div class='text-center'><p class=''>This is over 50 miles away. If you'd like to see it, please go ahead and ...</p><a href='/subscribe' class='btn btn-primary'>Upgrade</a></div>";
                      var title = "Aww shucks!!";
                    if(data.status == "ok")
                    {
                      var result = data.result;
                      var content = "<div class=''><div class='timeline-top-info   '>";
                      content += "<div class='  pull-right' style='margin-left: 5px;'>";
                      content += "<a type='button' class='btn btn-primary btn-xs' href='/"+result.username+"/post/"+result.updates.tweet_id+"'>";
                      content += "<i class='fa fa-arrow-right fa-lg' style='color:#fff;'></i> ";
                      content += "</a>";
                      content += "</div>   ";
                      content += "</div>";
                      content += "<div class='media margin-none'>   ";
                      content += "<div class=' '>";
                      content += result.updates.status;
                      content += "</div>";
                      content += "<div class=''>";
                      content += "<img src='"+result.profile_img+"' class='img-responsive'>";
                      content += "</div>";
                      content += "</div> ";
                      content += "<div class='timeline-bottom  border-top clearfix innerTB half'>";
                      content += "<a href='http://maps.google.com/maps?saddr=51.4529956141,-2.62451568043&amp;daddr=51.4619294,-2.5891196' target='_blank' data-placement='top' data-toggle='tooltip' class='pull-right' rel='tooltip' title='' data-original-title='Get directions'> ";
                      content += "<i class='fa fa-location-arrow fa-fw'></i> "+result.distance+" miles  ";
                      content += "</a>";
                      if(result.type_user.length>0)
                      {
                          content += "<i class='fa fa-home fa-fw'></i>";
                      }
                      
                      for(var index in result.type_user)
                      {
                        var biz_type = result.type_user[index];
                        content += '<a href="/activity/?b='+encodeURIComponent(biz_type)+'" class="innerR half">'+biz_type+'</a> ';
                      }
                      content += "</div> ";
                      content += "<div class='border-top innerT'> ";
                      content += "<p class='small text-center'>";
                      content += "<i class='fa fa-comments fa-fw'></i>";
                      content += "<a href='#'>See all 3 replies</a>";
                      content += "</p>";
                      content += "<input class='form-control input-sm enterhandler reply_input' data-tweet-id='"+result.updates.tweet_id+"' data-main='main' type='text' placeholder='Reply to "+result.username+"'  data-toggle='market-reply'  data-mentions='"+result.username+"'> ";
                      content += "</div>";
                      content += "</div>";
                      var title = result.name;
                    }
                   
                   $(that).popover({
                              trigger : "click",
                              placement : 'left',
                              html : true,
                              title:title,
                              content: content
                          }).popover("show");
                       $(that).attr('data-trigger',"click");
 
}, "json");
                      
                });
                 });


              </script>
              
{% endblock %}