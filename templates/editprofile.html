{% extends 'tbase.html' %}
{% load staticfiles %}
{% block head %}

<link rel="stylesheet" href="/static/css/docsupport/prism.css">
<link rel="stylesheet" href="/static/css/chosen.min.css">

<style type="text/css" media="all">
    /* fix rtl for demo */
  .chosen-rtl .chosen-drop { left: -9000px; }
  .typeempty{
  display:none;
  }

</style>

{% endblock %}

{% block content %}

<div class="col-md-10"> 
  <form class="form-horizontal" name="myform" role="form" onsubmit="return validate_business_type()" method="POST" action=".">
  {% csrf_token %}
    
    <div class="form-group">
      <label for="user_fname_txt" class="col-sm-2 control-label">First Name</label>
      <div class="col-sm-5">
        <input type="text" id="user_fname_txt" class="form-control" placeholder="First name" value="{{first_name}}" name="first_name">
      </div>
    </div>

    <div class="form-group">
      <label for="user_lname_txt" class="col-sm-2 control-label">Last Name</label>
      <div class="col-sm-5">
        <input type="text" id="user_lname_txt" class="form-control" placeholder="Last name" value="{{last_name}}" name="last_name">
      </div>
    </div>
    <div class="form-group">
      <label for="id_sign_up_as" class="col-sm-2 control-label">Sign up as</label>
        {{form.sign_up_as.as_hidden}}
      <div class="col-sm-5">

        <div class="btn-group" data-toggle="buttons">
          <label class="btn btn-default {% ifequal sign_up_as 'Individual' %}active{% endifequal %}"> 
              <input type="radio" {% ifequal sign_up_as 'Individual' %} checked="checked" {% endifequal %} name="sign_up_as" id="option1" value="Individual" onchange="dataradio('Individual')"> Individual 
          </label> 
          <label class="btn btn-default {% ifequal sign_up_as 'Business' %}active{% endifequal %}">  
              <input type="radio" {% ifequal sign_up_as 'Business' %} checked="checked" {% endifequal %} name="sign_up_as"  id="option2" value="Business" onchange="dataradio('Business')"> Business 
          </label>
          <label class="btn btn-default {% ifequal sign_up_as 'Organisation' %}active{% endifequal %}">
              <input type="radio" {% ifequal sign_up_as 'Organisation' %} checked="checked" {% endifequal %} name="sign_up_as" id="option3" value="Organisation" onchange="dataradio('Organisation')"> Organisation
          </label>
        </div>

        <input type="hidden" id= "hidden_type" name="type">

      </div>

      </div>
      
      <div class="form-group" id="type_user_id"> 
        <label for="id_type_user" class="col-sm-2 control-label">Business type</label>
        <div class="col-sm-5">
          <select id= "dropdown3" data-placeholder="Farm, wholesaler, restaurant..." multiple  class="chosen-select" tabindex="6">
              <option value=""></option>
              {% for each in all_tags %}
              <optgroup label={{each.node}}>
                {% if each.childrens %}
                  {% for eachchild in each.childrens %}
                  <option>{{eachchild.node}}</option>
                  {% endfor %}
                {% else %}
                <option>{{each.node}}</option>
                {% endif %}
              </optgroup>
              {% endfor %}
            </select>
        </div>
      </div>
      
    <div class="form-group">
      <label for="user_desc_txt" class="col-sm-2 control-label">Description</label>
      <div class="col-sm-5">
        <textarea class="form-control" id="user_desc_txt" name="description" rows="5">{{description}}</textarea>
      </div>
    </div>

    <div class="form-group">
      <label for="phone" class="col-sm-2 control-label">Phone</label>
      <div class="col-sm-5">
        <input  id="phone" type="tel" class="form-control" placeholder="Phone number" value="{{phone}}" name="phone"  onblur="validateFeedback()" reqired="required">
      </div>
    </div>

    <div class="form-group">
      <label for="address" class="col-sm-2 control-label">Address</label>
      <div class="col-sm-5">
      <input type="text" id="address" required class="form-control" placeholder="Enter your address" value="{{address}}" name="address">
      <input id="find" type="hidden" value="find" />
      <p>Please drag and drop the marker to change your location.</p>
      <div class="map_canvas" style="width: 100%;height: 300px; margin-top:3%;"></div>
      <input name="lat" type="hidden" value=""  class="form-control">
      <input name="lng" type="hidden" value=""  class="form-control">
      <input name="formatted_address" type="hidden" value="" id="formatted_address" class="form-control">
      </div>
    </div>
      <div class="form-group">
        <div class="col-sm-offset-2 col-sm-5">
          <button type="submit" class="btn btn-primary" onclick="copydata()">Update</button>
        </div>
      </div> 

  </form>
</div> 


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
  <script src="/static/js/chosen.jquery.min.js" type="text/javascript"></script>
  <script src="/static/css/docsupport/prism.js" type="text/javascript" charset="utf-8"></script>
  

<script type="text/javascript">
  var selVals = String('{{type_user}}').split(',');
  for (var i=0; i < selVals.length; i++){
    $("select optgroup option").filter(function() {
        return $(this).text() == selVals[i];
    }).prop('selected', true);
  }

var business_type = '{{sign_up_as}}';
$( document ).ready(function() {
  if('{{sign_up_as}}'!="Business"){
    $('#type_user_id').toggleClass('typeempty');
    /*$('#dropdown3').attr('required','flase');*/
    /*$('#dropdown3').removeAttr('required');*/
    }
  else{
    /*$('#dropdown3').attr('required','true');*/
  }
});

function dataradio(value){
    // var result_val = $("input[name=options]:checked").val();
    business_type = value;
    if (value == "Business"){
        if ( $('#type_user_id').hasClass('typeempty') ){
          $('#type_user_id').removeClass('typeempty');
          /*$('#dropdown3').attr('required','true');*/
        }
    }
    else{
        if ( $('#type_user_id').hasClass('typeempty') ){
          }
        else{
            $('#type_user_id').addClass('typeempty');
        }
        /*$('#dropdown3').removeAttr('required');*/
    }
}
var config = {
      '.chosen-select'           : {max_selected_options: 3},
      '.chosen-select-deselect'  : {allow_single_deselect:true},
      '.chosen-select-no-single' : {disable_search_threshold:10},
      '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
      '.chosen-select-width'     : {width:"350px"}
    }
    for (var selector in config) {
      $(selector).chosen(config[selector]);
    }
    $('#dropdown3').chosen().ready(function(){
      $('.search-field input').attr('style', 'width:192px;height:30px;');
    });
function validateFeedback(){
    var phone = document.getElementById("phone");
    var RE = /[0-9]+/;
    var ph = String(phone.value).replace(' ','');
        ph = String(ph.value).replace('-','');
        ph = String(ph.value).replace('x','');
        ph = String(ph.value).replace('+','');
    if(!RE.test(phone.value))
    {
        alert("You have entered an invalid phone number");
        return false;
    }
    return true;
}

  function copydata(){
    var all_values = '';
    var elements = document.getElementsByClassName('search-choice');
    for(i=0;i<elements.length;i++){
      if(all_values==''){
        all_values = all_values + elements[i].children[0].innerHTML;  
      }
      else{
      all_values = all_values + ',' + elements[i].children[0].innerHTML;
      }
    }
    document.getElementById('hidden_type').value = all_values;
    }

  function validate_address(){
    address = document.getElementById("phone").value;
    ajax_request('check_valid_address', 'success_validate_address',{'address':address});
  }

  function success_validate_address(data){
    data = jQuery.parseJSON(data);
    if (data['valid'] != 'true'){
      alert('Invalid Address!!');
    }
  }
   
  function validate_business_type(){
    if (business_type == 'Business' && $('#hidden_type').val().length == 0){
      alert("Please select atleast one Business Type!");
      return false;
    }
  }

  $(function(){
      $("#address").geocomplete({
        map: ".map_canvas",
        details: "form ",
        markerOptions: {
          draggable: true
        }
      });
      
      $("#address").bind("geocode:dragged", function(event, latLng){
          lat = latLng.lat();
          lng = latLng.lng();

          $("input[name=lat]").val(lat);
          $("input[name=lng]").val(lng);
          $("#reset").show();

          var mylatlng = new google.maps.LatLng(lat,lng);
          geo_code(mylatlng);
      });
      
      
      $("#find").click(function(){
        $("#address").trigger("geocode");
      }).click();

    });

 function geo_code(latlng){
    geocoder = new google.maps.Geocoder();
    geocoder.geocode({'latLng': latlng}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              if (results[1]) {
                var formatted_address = results[1].formatted_address;
                $('#address').val('');
                $('#address').val(formatted_address);
                $('#formatted_address').val(formatted_address);
              } 
            } 
          });
}
</script>
{% endblock %}